<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<title>工作台</title>
<link rel=stylesheet href='bs/css/bootstrap.css' type='text/css'>
<script src="jq/jquery.min.js"></script>
<script src="filesaver.min.js" ></script>
<script src="bs/js/bootstrap.js"></script>
<link rel="stylesheet" type="text/css" href="jq/css/jquery-ui.min.css" />
<link rel="stylesheet" type="text/css" href="jq/css/jquery.wysiwyg.css" />
<link type="text/css" href="jq/css/jquery-ui-timepicker-addon.css"
	rel="stylesheet" />

<script type="text/javascript" src="jq/jquery-ui.min.js"></script>
<script type="text/javascript" src="jq/jquery-ui-datepicker.js"></script>
<script type="text/javascript" src="jq/jquery-ui-timepicker-addon.js"></script>
<script type="text/javascript" src="jq/jquery-ui-timepicker-zh-CN.js"></script>


<script src="ckeditor/ckeditor.js"></script>
<script src="ckeditor/adapters/jquery.js"></script>
 <style>
  #subtitle { 
				  width: 200px; 
				  height: 30px; 
				  padding: 0.5em; 
				  background-color: rgba(0,0,0,0.2);
				  color:rgb(255,255,255);
				  position: absolute; 
				  left: 155px; top: 300px;
	      text-align:left;
	      font-weight:bolder;
	  }
	  
	  #preview,#mapper{
				margin:0px;
		   position: absolute; 
	    left: 0px; top: 0px;
	  }
	  #preview{
					z-index:0;
		 }
	  #mapper { 
					background-color: rgba(55,0,0,0);
					cursor:crosshair;
	      z-index:100;
	                
	  }
	  
	  #XY { 
	  width: 60px; 
	  height: 30px; 
	  padding: 0.5em; 
	  background-color: rgba(0,0,0,0);
	  color:rgb(255,255,255);
	  position: absolute; 
	  left: 155px; top: 0px;
	  }
	  
  </style>
</head>
<body onkeydown="shortKey()">


	<div class="navbar navbar-default" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="navbar bs-navbar">
			<a class="navbar-brand" href="." target='_blank'>视频标注系统</a>
		
			<a class="btn navbar-brand" href="#" onclick='loadReport();'>报表</a>
			
			<a class="btn navbar-brand" href="#" onclick='loadImport();'>导入</a>
			

			<form class="navbar-form navbar-left" role="search">
				<div class="form-group">
					<input placeholder="查找" class="nav-brand form-control"
						onkeyup="search(this.value)" type="text">
				</div>
				<input id="auto" type="checkbox" onclick="autoRefresh()">自动刷新
			</form>
		
			<a class="btn navbar-brand" href="#passChange"
				onclick='passChange();'><span class='glyphicon glyphicon-user'></span></a>
			<a class="btn navbar-brand" href="logout.jsp"><span
				class='glyphicon glyphicon-log-out'></span></a>

		</div>
		<!-- /.navbar-collapse -->
	</div>

	<div id="main" class="container">
	
<div class="row" style="height:340px">
  <div  id="zero" class="col-md-6 label-default align-middle center embed-responsive embed-responsive-16by9"  style="text-align:center;height:100%;"  >
      <video id="preview" src="file:///home/pi/Videos/100.mp4" controls='true' style="height:100%;margin:5px;vertical-align: middle;" onfocus="useShort=false;" onblur="useShort=true"> 
      
      
      </video>
  <div id="mapper"  >
  坐标系
</div>
  <div id="subtitle"  >
  当前标注
</div>
<div id="XY"  >
  X,Y
</div>

  </div>
  <div class="col-md-6 label-info pre-scrollable"  style="height:100%">
				<table  class="table well">
					  <thead>
						<tr>
						  
						  <th scope="col col-md-1" style="width:125px">开始</th>
						  <th scope="col col-md-1" style="width:125px">结束</th>
						  <th scope="col"  style="width:200px">标签</th>
						 <th scope="col">删除</th>
						</tr>
					  </thead>
					<tbody id="tagList">
						<!--    测试数据   -->
					  <tr start_time="00:00:03,600" end_time="00:00:06,739" tagtext="交谈" x="176" y="59"><td><button class="btn" onclick="jump($(this).text())">00:00:03,600</button></td><td><button class="btn" onclick="jump($(this).text())">00:00:06,739</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">交谈</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr><tr start_time="00:00:07,942" end_time="00:00:12,957" tagtext="伪3D" x="111" y="200"><td><button class="btn" onclick="jump($(this).text())">00:00:07,942</button></td><td><button class="btn" onclick="jump($(this).text())">00:00:12,957</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">伪3D</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr><tr start_time="00:00:13,157" end_time="00:00:18,536" tagtext="爆炸" x="127" y="184"><td><button class="btn" onclick="jump($(this).text())">00:00:13,157</button></td><td><button class="btn" onclick="jump($(this).text())">00:00:18,536</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">爆炸</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr><tr start_time="00:00:19,602" end_time="00:00:24,885" tagtext="伪3D" x="220" y="182"><td><button class="btn" onclick="jump($(this).text())">00:00:19,602</button></td><td><button class="btn" onclick="jump($(this).text())">00:00:24,885</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">伪3D</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr><tr start_time="00:00:25,451" end_time="00:00:30,743" tagtext="地图" x="177" y="81"><td><button class="btn" onclick="jump($(this).text())">00:00:25,451</button></td><td><button class="btn" onclick="jump($(this).text())">00:00:30,743</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">地图</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr><tr start_time="00:00:33,523" end_time="00:00:42,390" tagtext="卡通" x="346" y="192"><td><button class="btn" onclick="jump($(this).text())">00:00:33,523</button></td><td><button class="btn" onclick="jump($(this).text())">00:00:42,390</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">卡通</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr><tr start_time="00:00:43,439" end_time="00:00:48,994" tagtext="赛车" x="208" y="191"><td><button class="btn" onclick="jump($(this).text())">00:00:43,439</button></td><td><button class="btn" onclick="jump($(this).text())">00:00:48,994</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">赛车</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr><tr start_time="00:00:52,434" end_time="00:00:55,026" tagtext="3D" x="174" y="186"><td><button class="btn" onclick="jump($(this).text())">00:00:52,434</button></td><td><button class="btn" onclick="jump($(this).text())">00:00:55,026</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">3D</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr><tr start_time="00:00:55,816" end_time="00:01:00,980" tagtext="射击" x="180" y="253"><td><button class="btn" onclick="jump($(this).text())">00:00:55,816</button></td><td><button class="btn" onclick="jump($(this).text())">00:01:00,980</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">射击</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr>
							<!--    测试数据   -->
					  <tr start_time="00:01:01,347" end_time="00:01:06,870" tagtext="地图" x="117" y="146"><td><button class="btn" onclick="jump($(this).text())">00:01:01,347</button></td><td><button class="btn" onclick="jump($(this).text())">00:01:06,870</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">地图</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr><tr start_time="00:01:07,882" end_time="00:01:08,578" tagtext="射击" x="195" y="234"><td><button class="btn" onclick="jump($(this).text())">00:01:07,882</button></td><td><button class="btn" onclick="jump($(this).text())">00:01:08,578</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">射击</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr><tr start_time="00:01:13,804" end_time="00:01:18,672" tagtext="赛车" x="195" y="234"><td><button class="btn" onclick="jump($(this).text())">00:01:13,804</button></td><td><button class="btn" onclick="jump($(this).text())">00:01:18,672</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">赛车</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr><tr start_time="00:01:19,537" end_time="00:01:21,939" tagtext="迷宫" x="369" y="142"><td><button class="btn" onclick="jump($(this).text())">00:01:19,537</button></td><td><button class="btn" onclick="jump($(this).text())">00:01:21,939</button></td><td ondblclick="fastEdit(this)" class="text-center" style="vertical-align:middle">迷宫</td><td class="text-center" style="vertical-align:middle"><span class="glyphicon glyphicon-trash" onclick="$(this).parent().parent().remove()"></span></td></tr></tbody>
					</table>
  </div>
</div>
<div class="row"  style="height:100px">
  <div class="col-md-2 label-warning"  style="height:100%">
		当前时间：<span id="time"></span> s  <br>
		当前坐标：<span id="statusXY"></span>
  	 <button  class="btn btn-default" type="button" onclick="download()">Save</button>
  </div>
  <div class="col-md-8 label-success"  style="height:100%;">
	  
				  <div class="col-md-12">
								 <div class="row" style="margin:3px;">
									                <div class="col-md-9">
														                  <div class="input-group">
																			
																							 <span class="input-group-addon" id="sizing-addon2">标签</span>
																							  <input id="currentTag"  type="text" class="form-control" aria-label="..." onfocus="useShort=false;" onblur="useShort=true">
																							  <span class="input-group-btn"  >
																								 <button  class="btn btn-default" type="button" onclick="addTag()">确定</button>
																							 </span>
																		  </div>
													</div>
													<div class="col-md-3">
																			<select  id="typeList" class="form-control" onChange='$("#currentTag").val(this.value)' > 
																						<option>交谈</option>
																						<option>伪3D</option>
																						<option>射击</option>
																						<option>地图</option>
																						<option>赛车</option>
																						<option>格斗</option>
																						<option>飞机</option>
																						<option>爆炸</option>
																						<option>燃烧</option>
																						<option>卡通</option>
																						<option>男性</option>
																						<option>女性</option>
																			</select>
													 </div>
								  </div>
								  	 <div class="row">
									                <div class="col-md-4">
														                  <div class="input-group">
																							 <span class="input-group-btn" >
																								 <button  class="btn btn-default" type="button"  onclick="setStartTime()" >开始时间[J]</button>
																							 </span>
																							 <input type="timestamp"  id="start_time" class="form-control" aria-label="...">
																		  </div>
													</div>
													<div class="col-md-4">
																		<div class="input-group">
																							 <span class="input-group-btn" >
																								 <button  class="btn btn-default" type="button"   onclick="setEndTime()">结束时间[K]</button>
																							 </span>
																							  <input type="timestamp" id="end_time" class="form-control" aria-label="...">
																		  </div>
													 </div>
													 <div class="col-md-4">
														 <button  class="btn btn-default" type="button"  onclick="video.playbackRate=$(this).text()">0.25</button>
														 <button  class="btn btn-default" type="button"  onclick="video.playbackRate=$(this).text()">0.5</button>
														 <button  class="btn btn-default" type="button"  onclick="video.playbackRate=$(this).text()">1.0</button>
														 <button  class="btn btn-default" type="button"  onclick="video.playbackRate=$(this).text()">2.0</button>
				
													 </div>
													 
								  </div>
					</div>
  </div>
  <div class="col-md-2 label-danger"  style="height:100%"><span id="status"></div>
</div>
	
	
	</div>


</body>

<script>
var video=null;
var useShort=true;
var X=0,Y=0;
function pad(n) {
    if (n < 10)
        return "0" + n;
    return n;
}
function jump(timestr){
        video.currentTime=str2sec(timestr);
}
function mksrt(){
	 let tagList=$("#tagList");
	 let tag=null;
	 let ret="";
     for(let i=0;i<tagList.children().size();i++){
				   tag=$(tagList.children()[i]);
				   ret+=(i+1)+"\n";
				   ret+=tag.attr("start_time")+" --"+"> "+tag.attr("end_time")+"\n";
				   ret+=tag.attr("tagText")+"\n\n";
				   
	}
	
	 return ret;
}
function download(){
	let srt=mksrt();
    let blob = new Blob([srt ], {type: "application/vnd.openblox.game-binary"});
    saveAs(blob, "tagList.srt");
}
function str2sec(str){
		let  dec=str.split(",");
	    let sec=dec[0].split(":");
	    let ret=parseInt(sec[0]*3600)+parseInt(sec[1]*60)+parseInt(sec[2])+parseFloat("0."+dec[1]);
	   // console.log(str+":"+ret);
	    return ret;
}
function  sec2str(sec){
	  let integer=parseInt(sec);
      let dec=sec-integer;
      let ss=integer %60;
      integer=(integer-ss)/60;
      let mm=integer%60;
      integer=(integer-mm)/60;
      let hh=integer;
      return  pad(hh)+":"+pad(mm)+":"+pad(ss)+","+dec.toFixed(3).toString().substring(2);
}
function getCurrentTag(){
              let tagList=$("#tagList");
		 	 let i=0,tag=null;
		 	 let now=video.currentTime;
			 let start_time,endtime;
		     for(i=0;i<tagList.children().size();i++){
				   tag=tagList.children()[i];
				   start_time=str2sec($(tag).attr("start_time"));
				   end_time=str2sec($(tag).attr("end_time"));
				  if(start_time<=now   &&  end_time>=now){
							return $(tag);
				   } 
			  }
              return  Object.create({attr:function(){return "";}});
}
function showTag(){
		let tag=getCurrentTag();
	  $("#subtitle").text(tag.attr("tagText"));
	  $("#subtitle").css("left",tag.attr("x")+"px");
	  $("#subtitle").css("top",tag.attr("y")+"px");
}
function showTime(){
			  //console.log(video.currentTime);
		
	    $("#time").text(sec2str(video.currentTime));
	    $("#statusXY").text("("+X+","+Y+")");
	           showTag();
	   
	    
	    		$( "#mapper" ).css("height",parseInt($(video).css("height"))-60);
		   $( "#mapper" ).css("width",$(video).css("width"));
}

function  setStartTime(){
	$("#start_time").val(sec2str(video.currentTime));
	if(video.paused){
						video.play();
	}
}

function  setEndTime(){
	$("#end_time").val(sec2str(video.currentTime));
	  if(!video.paused){
						video.pause();
	  }
}
function fastEdit(td){
				let val=$(td).text();
      $(td).html("<input id='tagContent' type='text' value='"+val+"' onfocus='useShort=false;' onblur='useShort=true'>");
                let input=$($(td).children()[0]);
                input.change(function(){
						let newValue=$(this).val();
						$(td).html(newValue);
						$(td).parent().attr("tagText",newValue);
				});

}
function addTag(){
     let start_time=$("#start_time").val();
     let end_time=$("#end_time").val();
     let tagText=$("#currentTag").val();

     let newTag="<tr start_time='"+start_time+"' end_time='"+end_time+"' tagText='"+tagText+"' x='"+X+"' y='"+Y+"'>"
                                 +"<td><button class='btn' onclick='jump($(this).text())' >"+start_time+"</button></td>"
                                 +"<td><button class='btn' onclick='jump($(this).text())' >"+end_time+"</button></td><td onDblClick='fastEdit(this)' class='text-center' style='vertical-align:middle'>"+ tagText+"</td>"
                                 +"<td  class='text-center' style='vertical-align:middle'><span class='glyphicon glyphicon-trash' onclick='$(this).parent().parent().remove()'></span></td>"
                                 +"</tr>";
                                 
             let tagList=$("#tagList");
			 let added=false;
			 let i=0,tag=null;
		     for(i=0;i<tagList.children().size();i++){
				   tag=tagList.children()[i];
				  if(str2sec($(tag).attr("start_time"))>str2sec(start_time)){
							$(tag).before(newTag);
							added=true;
						
							break;
				   } else  if(str2sec($(tag).attr("start_time"))==str2sec(start_time)){
					     	$(tag).before(newTag);
					     	$(tag).remove();
					       added=true;
						
							break;
				  }
			  }
			  if(!added){
					 tagList.append(newTag);
			  }
			  console.log(start_time+" --"+"> "+tagText);
  $("#tagList").parent().parent()[0].scrollTop = $("#tagList").parent().parent()[0].scrollHeight;
}
function showXY(e){
		let XY=$("#XY");
		let x=parseInt(e.clientX-$("#zero").position().left);
		let y=parseInt(e.clientY-$("#zero").position().top);
		XY.text("("+x+","+y+")");
		XY.css("left",x);
		XY.css("top",y-parseInt(XY.css("height")));
}
function setXY(e){
		let XY=$("#XY");
		let x=parseInt(e.clientX-$("#zero").position().left);
		let y=parseInt(e.clientY-$("#zero").position().top);
		X=x;
		Y=y;
		getCurrentTag().attr("X",x);
		getCurrentTag().attr("Y",y);
		
}
$(document).ready(function(){
	   video=$("video")[0];
		
		$("#status").html("J:Set Start Time<br>  K:Set End Time<br> Space:Play/Pause <br> H:Back <br> L:Forward");
		
		
		$("#currentTag").val($("#typeList").val());
	    setStartTime();
	    setEndTime();
		window.setInterval("showTime();",100);
		$( "#subtitle" ).draggable();
		$(video).css("margin","0px");
   $("#mapper").mousemove(function(e){showXY(e)});
   $("#mapper").mousedown(function(e){setXY(e)});

		//$( "#mapper" ).css("top","-"+$(video).css("height"));
		
});
function  shortKey(e) {
        // 兼容FF和IE和Opera
        var theEvent = e || window.event;
        var code = theEvent.keyCode || theEvent.which || theEvent.charCode;
        if(!useShort) return true;
        if (code == 13) {
            if(theEvent.target.tagName=="INPUT"){
         	      return true;
            }	
            return false;
        }
        if(code==74) {    // j
 			  setStartTime();
 			  
		}
        if(code==75) {    // k
 			  setEndTime();
 			   addTag();
		}
		if(code==32){    // space
				if(video.paused){
						video.play();
				}else{
					    video.pause();
				}
		}
		if(code==37||code==72){  // <-  H
			 if(video.paused)
			       video.currentTime-=0.2;
			 else
			       video.currentTime-=1;
		}
		if(code==39||code==76){  // ->   L
			if(video.paused)
			       video.currentTime+=0.2;
			 else
			       video.currentTime+=1;
		}
		
       console.log("shortKey:"+code);
        return true;
    }
</script>

</html>
